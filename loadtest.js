const axios = require('axios');
// function that executes 'function' (e.g. a requester n-Times).  ?randomized delay 1-30 ms
function runThisNTimes(functionToRun, nTimes, hasDelay = true, timeToExecuteTotalRequests) {
    let _currDelay = 0;
    [...Array(nTimes).keys()].map((el, index) => {
        _currDelay += singleRequestDelay(nTimes, timeToExecuteTotalRequests);
        setTimeout(() => {
            console.log({ hasSent: index, mustSend: nTimes });
            functionToRun()
        }, hasDelay ? _currDelay : 0)
    })
}



// function that sends get request to link
async function requestThisEndPoint(link) {
    let resp = await axios.get(link)
    // console.log(resp.data);
}

// function to calculate single request delay based on total requests and the time that it takes to complete those requests.
// aim is requests to be distributed harmonically in their time range.
function singleRequestDelay(totalRequests, timeToExecuteTotalRequests) {
    let currentRequestAVGDelay = timeToExecuteTotalRequests / totalRequests;
    console.log({ totalRequests, timeToExecuteTotalRequests, currentRequestAVGDelay });

    //add or remove delay of request
    Math.floor(Math.random() * 2) === 0 ? currentRequestAVGDelay += randomDelay(1) : currentRequestAVGDelay -= randomDelay(1);

    return currentRequestAVGDelay;
}

// function that calcs a random number between 1 and 30, as a delay.
// aim is each request to have an extra/less randomized delay time
function randomDelay(maxDelay = 30) {
    return Math.floor(Math.random() * maxDelay) + 1;
}




function simulation({ samplingRateMs, requestPerSamplingRateMsARRAY, endpoint }) {
    let array = requestPerSamplingRateMsARRAY
    let count = 0;
    array.forEach((item, index) => {
        setTimeout(() => {
            count = count + 1;
            runThisNTimes(() => requestThisEndPoint(endpoint), item, true, samplingRateMs);
            console.log({ count },);
        }, samplingRateMs * (index)) // run Nth request every n times

    })

}

// # of requests per range-time-unit
const myArr = [
    10,
    20,
    10,
    121,
    144,
    155,
    88,
    124,
    200,
    300,
    190,
    600,
    20,
    10,
    100,
    92,
    89,
    104,
    101,
    91,
    86,
    82,
    94,
    96,
    80,
    80,
    84,
    97,
    96,
    89,
    84,
    109,
    92,
    92,
    93,
    91,
    93,
    88,
    89,
    93,
    96,
    94,
    88,
    92,
    90,
    88,
    93,
    90,
    99,
    91,
    83,
    91,
    89,
    91,
    87,
    88,
    86,
    91,
    91,
    95,
    105,
    104,
    105,
    89,
    93,
    91,
    96,
    164,
    92,
    104,
    86,
    93,
    92,
    91,
    98,
    98,
    99,
    96,
    101,
    82,
    76,
    84,
    88,
    91,
    90,
    95,
    90,
    98,
    101,
    94,
    98,
    91,
    99,
    81,
    80,
    87,
    86,
    92,
    92,
    94,
    94,
    93,
    104,
    89,
    93,
    85,
    90,
    89,
    81,
    94,
    94,
    95,
    84,
    81,
    96,
    90,
    98,
    94,
    94,
    91,
    92,
    94,
    85,
    76,
    88,
    84,
    88,
    143,
    93,
    94,
    94,
    96,
    86,
    81,
    76,
    83,
    91,
    84,
    84,
    98,
    104,
    92,
    96,
    84,
    96,
    86,
    83,
    84,
    84,
    94,
    93,
    97,
    95,
    110,
    99,
    92,
    93,
    81,
    82,
    78,
    75,
    81,
    91,
    105,
    94,
    104,
    101,
    96,
    103,
    79,
    86,
    79,
    78,
    83,
    87,
    109,
    98,
    104,
    102,
    102,
    83,
    76,
    84,
    76,
    85,
    77,
    91,
    93,
    153,
    111,
    102,
    101,
    90,
    83,
    82,
    75,
    82,
    78,
    94,
    90,
    91,
    102,
    101,
    108,
    86,
    81,
    83,
    83,
    84,
    79,
    85,
    93,
    109,
    108,
    110,
    106,
    97,
    91,
    79,
    82,
    78,
    75,
    82,
    90,
    101,
    98,
    108,
    99,
    88,
    80,
    78,
    81,
    75,
    75,
    82,
    95,
    98,
    96,
    98,
    79,
    74,
    76,
    77,
    80,
    75,
    83,
    85,
    94,
    94,
    91,
    92,
    86,
    77,
    76,
    82,
    83,
    87,
    87,
    97,
    89,
    102,
    90,
    83,
    81,
    88,
    74,
    85,
    82,
    92,
    92,
    90,
    84,
    96,
    106,
    96,
    84,
    86,
    78,
    87,
    89,
    90,
    85,
    92,
    85,
    81,
    98,
    93,
    100,
    92,
    93,
    79,
    95,
    94,
    88,
    89,
    80,
    83,
    86,
    86,
    86,
    80,
    84,
    87,
    85,
    88,
    89,
    98,
    86,
    90,
    90,
    113,
    92,
    95,
    98,
    95,
    97,
    81,
    83,
    92,
    90,
    87,
    92,
    87,
    86,
    87,
    89,
    93,
    94,
    91,
    94,
    88,
    85,
    87,
    84,
    92,
    86,
    107,
    98,
    90,
    91,
    87,
    84,
    77,
    77,
    90,
    86,
    95,
    95,
    95,
    98,
    95,
    90,
    83,
    84,
    78,
    80,
    90,
    91,
    99,
    94,
    107,
    85,
    87,
    85,
    83,
    86,
    81,
    88,
    93,
    96,
    88,
    87,
    86,
    93,
    90,
    90,
    91,
    99,
    83,
    85,
    87,
    86,
    85,
    90,
    88,
    75,
    79,
    83,
    82,
    86,
    86,
    84,
    86,
    88,
    79,
    88,
    79,
    79,
    84,
    77,
    85,
    83,
    81,
    88,
    82,
    83,
    81,
    91,
    84,
    80,
    88,
    93,
    88,
    90,
    90,
    91,
    80,
    83,
    80,
    86,
    81,
    85,
    88,
    91,
    85,
    87,
    81,
    102,
    78,
    79,
    77,
    87,
    80,
    88,
    84,
    85,
    88,
    78,
    89,
    81,
    85,
    82,
    84,
    104,
    80,
    89,
    81,
    78,
    75,
    72,
    81,
    80,
    83,
    88,
    97,
    78,
    80,
    74,
    73,
    71,
    73,
    76,
    89,
    93,
    93,
    79,
    83,
    72,
    74,
    80,
    79,
    92,
    87,
    92,
    88,
    83,
    79,
    78,
    85,
    75,
    81,
    87,
    83,
    95,
    84,
    85,
    75,
    114,
    80,
    77,
    77,
    75,
    79,
    76,
    86,
    81,
    77,
    85,
    87,
    88,
    86,
    84,
    82,
    79,
    77,
    81,
    84,
    90,
    86,
    88,
    92,
    97,
    80,
    91,
    87,
    81,
    80,
    73,
    89,
    88,
    84,
    85,
    77,
    84,
    79,
    84,
    85,
    91,
    92,
    85,
    76,
    73,
    80,
    79,
    87,
    81,
    80,
    90,
    83,
    81,
    80,
    76,
    81,
    77,
    86,
    81,
    81,
    113,
    84,
    83,
    75,
    82,
    80,
    71,
    69,
    76,
    86,
    76,
    86,
    83,
    74,
    77,
    77,
    78,
    78,
    77,
    85,
    86,
    84,
    78,
    84,
    78,
    84,
    85,
    83,
    99,
    84,
    85,
    79,
    68,
    78,
    76,
    90,
    85,
    83,
    84,
    80,
    89,
    77,
    84,
    78,
    76,
    66,
    77,
    79,
    76,
    73,
    74,
    76,
    78,
    87,
    73,
    81,
    82,
    75,
    68,
    78,
    105,
    88,
    70,
    71,
    63,
    69,
    73,
    78,
    81,
    68,
    76,
    73,
    74,
    81,
    82,
    87,
    88,
    70,
    73,
    74,
    86,
    80,
    80,
    84,
    76,
    76,
    83,
    75,
    75,
    76,
    66,
    64,
    74,
    71,
    83,
    77,
    81,
    71,
    79,
    71,
    70,
    76,
    85,
    98,
    88,
    91,
    85,
    70,
    69,
    64,
    70,
    75,
    87,
    95,
    86,
    76,
    68,
    69,
    72,
    74,
    98,
    70,
    76,
    71,
    67,
    75,
    82,
    85,
    85,
    87,
    78,
    85,
    71,
    69,
    83,
    81,
    86,
    85,
    75,
    75,
    68,
    71,
    65,
    81,
    75,
    112,
    113,
    108,
    95,
    87,
    89,
    91,
    95,
    109,
    103,
    115,
    108,
    106,
    104,
    102,
    99,
    96,
    97,
    88,
    88,
    99,
    110,
    118,
    111,
    116,
    101,
    89,
    90,
    68,
    78,
    79,
    93,
    85,
    69,
    71,
    83,
    80,
    86,
    94,
    95,
    86,
    94,
    78,
    79,
    79,
    78,
    90,
    84,
    90,
    81,
    72,
    81,
    78,
    83,
    80,
    92,
    88,
    82,
    76,
    77,
    77,
    77,
    81,
    84,
    90,
    95,
    87,
    81,
    69,
    73,
    79,
    89,
    86,
    77,
    86,
    83,
    79,
    78,
    74,
    73,
    72,
    81,
    83,
    73,
    72,
    74,
    76,
    74,
    77,
    77,
    84,
    84,
    77,
    83,
    76,
    93,
    77,
    76,
    81,
    81,
    81,
    86,
    79,
    72,
    73,
    80,
    75,
    88,
    78,
    79,
    78,
    77,
    79,
    74,
    78,
    76,
    79,
    75,
    76,
    84,
    88,
    89,
    86,
    82,
    77,
    79,
    84,
    95,
    87,
    77,
    91,
    81,
    82,
    82,
    73,
    79,
    77,
    82,
    80,
    79,
    81,
    78,
    82,
    85,
    80,
    81,
    77,
    78,
    74,
    85,
    84,
    89,
    93,
    86,
    77,
    95,
    71,
    77,
    74,
    91,
    88,
    89,
    72,
    72,
    72,
    70,
    75,
    90,
    93,
    91,
    85,
    81,
    87,
    77,
    72,
    78,
    84,
    89,
    89,
    83,
    86,
    75,
    68,
    66,
    76,
    84,
    80,
    82,
    79,
    76,
    78,
    84,
    81,
    72,
    79,
    74,
    75,
    71,
    69,
    83,
    83,
    89,
    81,
    73,
    70,
    72,
    74,
    79,
    84,
    89,
    88,
    79,
    77,
    78,
    72,
    107,
    78,
    85,
    92,
    83,
    87,
    76,
    74,
    72,
    79,
    84,
    75,
    91,
    84,
    79,
    84,
    79,
    78,
    75,
    88,
    82,
    82,
    82,
    85,
    76,
    79,
    86,
    87,
    78,
    80,
    78,
    82,
    80,
    85,
    88,
    87,
    90,
    82,
    86,
    77,
    78,
    80,
    75,
    84,
    76,
    90,
    83,
    81,
    75,
    79,
    80,
    82,
    87,
    84,
    77,
    87,
    89,
    87,
    80,
    81,
    98,
    76,
    78,
    78,
    84,
    78,
    84,
    79,
    84,
    89,
    85,
    96,
    81,
    74,
    72,
    76,
    75,
    82,
    82,
    83,
    97,
    94,
    87,
    90,
    81,
    74,
    66,
    68,
    70,
    74,
    78,
    78,
    82,
    86,
    85,
    85,
    80,
    85,
    69,
    72,
    71,
    81,
    81,
    79,
    80,
    81,
    77,
    78,
    80,
    81,
    75,
    79,
    80,
    81,
    77,
    74,
    90,
    80,
    75,
    77,
    127,
    84,
    77,
    81,
    82,
    93,
    86,
    90,
    79,
    89,
    79,
    83,
    95,
    86,
    78,
    80,
    75,
    95,
    68,
    77,
    74,
    91,
    95,
    91,
    97,
    82,
    80,
    69,
    73,
    73,
    77,
    86,
    81,
    93,
    90,
    99,
    90,
    75,
    79,
    83,
    73,
    74,
    75,
    91,
    80,
    94,
    82,
    87,
    83,
    81,
    74,
    72,
    77,
    77,
    76,
    82,
    78,
    88,
    78,
    82,
    124,
    82,
    90,
    73,
    77,
    84,
    91,
    80,
    76,
    82,
    97,
    86,
    82,
    80,
    81,
    97,
    81,
    80,
    86,
    85,
    87,
    75,
    68,
    72,
    72,
    92,
    81,
    92,
    91,
    83,
    88,
    89,
    88,
    79,
    84,
    79,
    72,
    75,
    82,
    89,
    86,
    96,
    93,
    83,
    87,
    86,
    82,
    80,
    72,
    74,
    82,
    81,
    84,
    86,
    81,
    88,
    107,
    95,
    93,
    89,
    132,
    79,
    76,
    74,
    77,
    84,
    85,
    93,
    84,
    97,
    96,
    85,
    92,
    86,
    83,
    78,
    79,
    76,
    80,
    87,
    92,
    90,
    81,
    80,
    80,
    81,
    84,
    80,
    77,
    85,
    76,
    80,
    85,
    90,
    79,
    87,
    79,
    76,
    75,
    87,
    94,
    101,
    109,
    87,
    83,
    87,
    103,
    91,
    90,
    91,
    78,
    85,
    84,
    90,
    89,
    80,
    83,
    87,
    81,
    88,
    140,
    94,
    87,
    82,
    77,
    82,
    84,
    88,
    96,
    87,
    89,
    88,
    82,
    83,
    79,
    83,
    73,
    80,
    76,
    77,
    89,
    90,
    91,
    88,
    91,
    104,
    94,
    90,
    74,
    76,
    87,
    90,
    98,
    92,
    96,
    91,
    98,
    87,
    81,
    82,
    83,
    78,
    79,
    78,
    79,
    78,
    90,
    85,
    89,
    84,
    84,
    74,
    76,
    81,
    86,
    86,
    87,
    80,
    91,
    91,
    161,
    101,
    108,
    88,
    84,
    83,
    84,
    86,
    83,
    87,
    84,
    83,
    92,
    93,
    87,
    85,
    88,
    79,
    80,
    83,
    83,
    93,
    85,
    87,
    83,
    108,
    107,
    87,
    103,
    84,
    86,
    89,
    85,
    87,
    81,
    99,
    104,
    96,
    84,
    82,
    87,
    83,
    85,
    87,
    87,
    91,
    98,
    95,
    98,
    103,
    94,
    93,
    99,
    83,
    85,
    96,
    89,
    94,
    92,
    91,
    153,
    98,
    90,
    92,
    86,
    88,
    94,
    93,
    87,
    85,
    83,
    87,
    87,
    88,
    96,
    98,
    95,
    102,
    97,
    88,
    84,
    83,
    87,
    89,
    89,
    98,
    98,
    108,
    98,
    95,
    88,
    90,
    101,
    83,
    90,
    92,
    93,
    102,
    91,
    111,
    103,
    99,
    93,
    91,
    93,
    88,
    84,
    90,
    95,
    98,
    103,
    121,
    120,
    105,
    97,
    104,
    105,
    91,
    92,
    93,
    138,
    117,
    106,
    105,
    104,
    123,
    106,
    99,
    99,
    103,
    100,
    89,
    91,
    89,
    108,
    98,
    104,
    105,
    84,
    94,
    94,
    96,
    92,
    91,
    111,
    102,
    113,
    105,
    98,
    100,
    94,
    109,
    103,
    95,
    93,
    89,
    98,
    95,
    96,
    99,
    102,
    102,
    101,
    92,
    101,
    113,
    110,
    98,
    97,
    95,
    96,
    90,
    92,
    90,
    90,
    94,
    93,
    94,
    94,
]

// simulation({ samplingRateMs: 15000, requestPerSamplingRateMsARRAY: myArr, endpoint: 'http://localhost:8000/mockl' })


const endpoints = ['http://localhost:8000/mockl', 'http://localhost:8000/mock2'];

function multipleEndpointLoadTest({ endpoints, simulationFunction }) {
    endpoints.forEach(endpoint => {
        simulationFunction({ samplingRateMs: 15000, requestPerSamplingRateMsARRAY: myArr, endpoint: endpoint })
    })
}

multipleEndpointLoadTest({ endpoints: endpoints, simulationFunction: simulation })
